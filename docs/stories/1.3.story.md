# Story 1.3: Weather API Integration

## Status
Draft

## Story
As a user,  
I want to query weather forecasts for any location,  
so that I can retrieve basic weather data that will later inform activity recommendations.

## Epic Context
**Epic 1: Foundation & Core Infrastructure** - Establish project setup, configuration management, and basic weather API integration to create a working CLI application with weather data retrieval capabilities for any location.

## Acceptance Criteria
1. Integration with weather API (OpenWeatherMap or similar) implemented
2. CLI accepts location input (coordinates, city names, postal codes)
3. Weather data retrieved and parsed for 7-day forecasts
4. Basic weather information displayed in human-readable CLI format
5. Error handling for API failures, invalid locations, and network issues
6. Rate limiting and retry logic implemented

## Dev Notes

### Architecture Context
- **Source:** docs/architecture.md#external-apis - OpenWeatherMap API
- **Source:** docs/architecture.md#components - Weather API Client, Cache Layer
- **Source:** docs/architecture.md#data-models - WeatherData model
- **File Locations:** 
  - `src/api.rs` - All API clients and orchestration
  - `src/cache.rs` - Local caching with Sled
  - `src/models.rs` - All data structures

### Technology Stack Requirements
- **HTTP Client:** reqwest 0.11+ (synchronous support)
- **JSON Serialization:** serde + serde_json 1.0+
- **Date/Time:** chrono 0.4+
- **Caching:** sled 0.34+
- **Error Handling:** anyhow + thiserror

### Dependencies for Cargo.toml
```toml
reqwest = { version = "0.11", features = ["json", "blocking"] }
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
chrono = { version = "0.4", features = ["serde"] }
sled = "0.34"
```

### OpenWeatherMap API Integration
- **Base URL:** https://api.openweathermap.org/data/2.5
- **Key Endpoints:**
  - `GET /weather` - Current weather conditions
  - `GET /forecast` - 5-day/3-hour forecast data
- **Authentication:** API key via query parameter
- **Rate Limits:** 1,000 calls/day (free tier), 60 calls/minute

### Data Models to Implement
```rust
// In src/models.rs
#[derive(Debug, Serialize, Deserialize, Clone)]
pub struct WeatherData {
    pub timestamp: DateTime<Utc>,
    pub temperature: f32,           // Celsius
    pub wind_speed: f32,            // m/s
    pub wind_direction: u16,        // degrees (0-360)
    pub wind_gust: Option<f32>,     // m/s
    pub precipitation: f32,         // mm
    pub cloud_cover: Option<u8>,    // percentage (0-100)
    pub pressure: f32,              // hPa
    pub visibility: Option<f32>,    // kilometers
}
```

### Cache Strategy
- **Key Pattern:** `"weather:{lat}:{lon}:{date}"`
- **TTL:** 6 hours (as defined in architecture)
- **Storage:** Sled embedded database

## Tasks / Subtasks

### Task 1: Data Models (AC: 3)
1. Create WeatherData struct in `src/models.rs`
2. Add serde derive macros for JSON serialization
3. Implement validation and conversion methods
4. Add utility functions for weather data manipulation

### Task 2: Cache Layer Foundation (AC: 6)
1. Create Cache Layer component in `src/cache.rs`
2. Implement Sled database initialization
3. Add generic get/set methods with TTL support
4. Implement cache key generation for weather data
5. Add cache invalidation and cleanup methods

### Task 3: Weather API Client (AC: 1, 6)
1. Create Weather API Client in `src/api.rs`
2. Implement OpenWeatherMap API integration:
   - Current weather endpoint
   - 5-day forecast endpoint
3. Add API key authentication
4. Implement rate limiting and retry logic with exponential backoff
5. Add timeout configuration (30 seconds per architecture)

### Task 4: Location Input Processing (AC: 2)
1. Add location parsing functions:
   - Coordinates (lat, lon)
   - City names
   - Postal codes
2. Implement geocoding for city names/postal codes
3. Add input validation and error handling
4. Support multiple input formats

### Task 5: API Integration with Caching (AC: 1, 3, 6)
1. Implement cache-first API strategy:
   - Check cache before API call
   - Store API responses in cache
   - Handle cache misses gracefully
2. Parse OpenWeatherMap JSON responses to WeatherData
3. Implement 7-day forecast aggregation
4. Add error handling for API failures and network issues

### Task 6: CLI Command Implementation (AC: 2, 4)
1. Add weather command to CLI in `src/main.rs`
2. Implement location argument parsing
3. Format weather output for human readability:
   - Current conditions summary
   - 7-day forecast table
   - Wind and precipitation details
4. Add output format options (text, JSON)

### Task 7: Error Handling (AC: 5, 6)
1. Implement comprehensive error types:
   - API connection failures
   - Invalid API responses
   - Location not found
   - Rate limit exceeded
2. Add user-friendly error messages
3. Implement graceful degradation with cached data

### Task 8: Testing (AC: 1-6)
1. Unit tests for WeatherData model
2. Unit tests for cache operations
3. Integration tests with API mocking (using mockito)
4. Test error handling scenarios
5. Test cache TTL and expiration

## Definition of Done
- [ ] All acceptance criteria met
- [ ] WeatherData model correctly parses API responses
- [ ] Cache layer stores and retrieves weather data with 6-hour TTL
- [ ] CLI accepts various location input formats
- [ ] Weather forecast displays in human-readable format
- [ ] Error handling covers network, API, and validation failures
- [ ] Rate limiting prevents API quota exceeded errors
- [ ] Unit and integration tests pass
- [ ] Documentation updated with usage examples

## Technical Notes
- Use reqwest blocking client for synchronous API calls
- Implement proper error type hierarchy for different failure modes
- Cache weather data by rounded coordinates to increase cache hit rate
- Follow OpenWeatherMap API best practices for authentication
- Consider API response caching at HTTP level for efficiency

## Dependencies
- Story 1.1 (Project Setup and CLI Framework) - requires CLI structure
- Story 1.2 (Configuration Management) - requires API key configuration

## Estimated Effort
4-5 hours of focused development