# Story 1.5: OpenMeteo API Integration - Brownfield Addition

## Status
InProgress

## Story
As a user of the TravelAI CLI,  
I want the weather data to be retrieved without requiring API key configuration,  
So that I can get weather forecasts immediately without setup barriers or API limits.

## Epic Context
**Epic 1: Foundation & Core Infrastructure** - Enhance existing weather API integration by switching to OpenMeteo API to eliminate API key requirements while maintaining all current functionality.

This story builds on the established foundation from Stories 1.1-1.4:
- Story 1.1: Project setup and CLI framework
- Story 1.2: Configuration management system
- Story 1.3: OpenWeatherMap API integration (to be replaced)
- Story 1.4: Logging and error handling infrastructure

## Story Context
This change builds on the existing weather API integration (Story 1.3) which established:
- Weather data models in `src/models.rs`
- API client patterns in `src/api.rs` 
- Cache layer integration in `src/cache.rs`
- CLI weather command implementation
- Error handling and logging infrastructure

The OpenMeteo API provides similar forecast data without authentication requirements, fitting existing patterns while removing the API key barrier for users.

## Acceptance Criteria

### Functional Requirements
1. Weather data retrieval works without API key configuration
2. Current weather and 5-day forecast data available  
3. Location input supports coordinates, city names (via geocoding)
4. Weather output format remains consistent for users
5. Paragliding suitability analysis continues to work

### Integration Requirements
6. Existing cache layer continues to work with new API data
7. CLI commands maintain same interface (`weather --location`)
8. Error handling follows established patterns
9. Configuration system updated to remove API key requirement
10. All existing tests pass with minimal modifications

### Quality Requirements
11. Performance comparable or better than OpenWeatherMap
12. Error messages remain user-friendly
13. Logging integration follows established patterns
14. Code follows existing style and patterns

## Dev Notes

### Architecture Context
- **Integration Pattern**: Replace OpenWeatherMap client with OpenMeteo using `open-meteo` crate
- **Crate Selection**: Use `open-meteo = "0.2"` - well-maintained crate with async support
- **API Endpoint**: https://api.open-meteo.com/v1/forecast
- **Geocoding**: OpenMeteo provides built-in geocoding API

### Technical Implementation
- **Primary Change**: Update `WeatherApiClient` struct in `src/api.rs` to use `open-meteo` crate instead of direct OpenWeatherMap API calls
- **Configuration**: Make `weather.api_key` field optional in `TravelAiConfig` struct in `src/config.rs`
- **Data Mapping**: Map OpenMeteo response format to existing `WeatherData` and `WeatherForecast` structs in `src/models.rs`
- **Geocoding**: Replace current geocoding in `LocationParser` with OpenMeteo's geocoding API
- **Error Handling**: Maintain existing `TravelAiError` and `ErrorCode` patterns from Story 1.4
- **Logging**: Preserve existing tracing integration patterns established in Story 1.4

### Current Codebase Context (from Story 1.3 implementation)
- **API Client**: `WeatherApiClient` struct with `get_current_weather()`, `get_forecast()`, `geocode()` methods
- **Models**: `WeatherData`, `WeatherForecast`, `Location` structs with OpenWeatherMap response mapping
- **Cache**: `Cache` struct with `get_weather_forecast()` and `set_weather_forecast()` methods
- **CLI**: Weather command in `src/main.rs` with `get_weather_forecast()` and `display_weather_forecast()` functions
- **Config**: `WeatherConfig` struct with `api_key`, `base_url`, `timeout_seconds`, `max_retries` fields

### Key Dependencies
- Add `open-meteo = "0.2"` to Cargo.toml (verified version exists)
- No tokio runtime updates needed - current implementation uses blocking reqwest
- Maintain compatibility with existing blocking HTTP patterns

## Tasks / Subtasks

### Task 1: Dependency Integration (AC: 1, 9)
1. Add `open-meteo = "0.2"` crate dependency to Cargo.toml
2. Update Cargo.toml with required features for HTTP client integration
3. Verify compatibility with existing blocking reqwest patterns (no async changes needed)
4. Review crate documentation and examples for integration approach

### Task 2: API Client Refactoring (AC: 1, 2, 3, 8)
1. Create new OpenMeteo client wrapper in `src/api.rs` alongside existing client
2. Implement current weather data fetching using OpenMeteo forecast endpoint
3. Implement 5-day forecast retrieval with hourly data parsing
4. Add geocoding integration using OpenMeteo's geocoding API (no separate service needed)
5. Maintain existing rate limiting and retry logic patterns from Story 1.3
6. Preserve existing error handling patterns established in Story 1.4

### Task 3: Data Model Compatibility (AC: 4, 5, 13)
1. Map OpenMeteo response format to existing `WeatherData` struct in `src/models.rs`
2. Ensure paragliding suitability calculations still work with new data format
3. Verify temperature, wind, precipitation data alignment matches existing display
4. Test weather condition mapping for display consistency with current output
5. Maintain logging integration patterns from Story 1.4

### Task 4: Configuration Updates (AC: 9, 12)
1. Make `weather.api_key` optional in `TravelAiConfig` struct in `src/config.rs`
2. Update default configuration handling to not require API key
3. Remove API key validation from startup sequence in `src/main.rs`
4. Update configuration error messages to reflect optional API key
5. Preserve existing configuration file format for backward compatibility

### Task 5: Testing and Validation (AC: 10, 11, 12, 13, 14)
1. Update unit tests in `src/api.rs` to work with OpenMeteo responses
2. Modify integration tests in `tests/integration_tests.rs` to remove API key requirements
3. Test geocoding functionality with coordinates, city names, and postal codes (AC: 3)
4. Validate caching works with new data format in `src/cache.rs` (AC: 6)
5. Verify error handling for network issues maintains user-friendly messages (AC: 12)
6. Ensure performance logging continues to work as established in Story 1.4 (AC: 13)

### Task 6: Documentation and CLI Updates (AC: 7, 14)
1. Update configuration examples in config files to remove API key requirement
2. Update README.md if it mentions OpenWeatherMap setup requirements
3. Verify CLI help text is accurate and doesn't reference API keys
4. Ensure CLI command interface remains exactly the same (`weather --location`) (AC: 7)
5. Maintain code style consistency with existing patterns (AC: 14)

## Definition of Done
- [ ] OpenMeteo API client implemented using `open-meteo` crate
- [ ] All weather commands work without API key setup  
- [ ] Existing functionality preserved (caching, CLI, display)
- [ ] All tests updated and passing
- [ ] Configuration updated to not require API keys
- [ ] Error handling maintains user-friendly messages
- [ ] Performance logging continues to work
- [ ] Geocoding works for coordinates, city names, postal codes
- [ ] Paragliding suitability analysis functions correctly
- [ ] CLI output format remains consistent for users

## Testing
### Unit Tests
- OpenMeteo API client methods
- Data transformation from OpenMeteo format to WeatherData
- Geocoding functionality
- Error handling for various API failure scenarios

### Integration Tests  
- Complete weather command flow without API keys
- Cache integration with new data format
- CLI error messages for invalid locations
- Performance under various network conditions

## Dependencies
- Story 1.3 (Weather API Integration) - builds on existing architecture
- Story 1.4 (Logging and Error Handling) - maintains logging patterns

## Estimated Effort
2-3 hours of focused development

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-30 | v1.0 | Initial story creation for OpenMeteo API integration | Sarah (PO) |
| 2025-11-30 | v1.1 | Updated with template compliance fixes and enhanced task-AC mapping | Sarah (PO) |

---

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
_To be populated by development agent during implementation_

### Completion Notes List
_To be populated by development agent during implementation_

### File List
_To be populated by development agent - list all files created, modified, or affected during story implementation_

---

## QA Results
_To be populated by QA Agent after story implementation review_