# Story 1.2: Configuration Management

## Status
Draft

## Story
As a user,  
I want to configure API keys and default settings through a config file,  
so that I don't have to enter credentials repeatedly and can customize behavior.

## Epic Context
**Epic 1: Foundation & Core Infrastructure** - Establish project setup, configuration management, and basic weather API integration to create a working CLI application with weather data retrieval capabilities for any location.

## Acceptance Criteria
1. Configuration file format (TOML/YAML) defined and documented
2. CLI reads configuration from standard locations (~/.config/travelai/ or similar)
3. Environment variable override support for CI/CD and testing
4. Configuration validation with clear error messages for missing or invalid settings
5. Sample configuration file provided with documentation

## Dev Notes

### Architecture Context
- **Source:** docs/architecture.md#tech-stack  
- **Source:** docs/architecture.md#components - Configuration Manager component
- **File Location:** `src/config.rs` - Configuration management
- **Component:** Configuration Manager with interfaces: `load_config()`, `validate_api_keys()`, `get_cache_settings()`

### Technology Stack Requirements
- **Configuration:** config + toml 0.13+ / 0.8+
- **Error Handling:** anyhow + thiserror for configuration errors
- **File System:** Standard library for XDG config directories

### Dependencies for Cargo.toml
```toml
config = "0.13"
toml = "0.8"
serde = { version = "1.0", features = ["derive"] }
dirs = "5.0"  # For XDG config directories
```

### Configuration Structure
Based on architecture requirements:
```toml
[weather]
api_key = "your_openweathermap_api_key"
base_url = "https://api.openweathermap.org/data/2.5"
timeout_seconds = 30
max_retries = 3

[cache]
ttl_hours = 6
max_size_mb = 100
location = "~/.cache/travelai"

[logging]
level = "info"
format = "pretty"  # or "json"

[defaults]
search_radius_km = 50
max_sites = 10
```

### File Locations
- **Config file:** `~/.config/travelai/config.toml`
- **Cache directory:** `~/.cache/travelai/`
- **Example config:** `config/default.toml` in project root

## Tasks / Subtasks

### Task 1: Configuration Data Structures (AC: 1)
1. Define configuration structs in `src/config.rs`:
   - `TravelAiConfig` (root config)
   - `WeatherConfig` (API settings)
   - `CacheConfig` (cache settings)
   - `LoggingConfig` (logging settings)
   - `DefaultsConfig` (default values)
2. Add serde derive macros for TOML serialization
3. Implement validation methods for each config section

### Task 2: Configuration Loading (AC: 2)
1. Implement `load_config()` function
2. Use XDG config directory standard (`~/.config/travelai/`)
3. Create config directory if it doesn't exist
4. Handle missing config file gracefully with defaults
5. Parse TOML format with helpful error messages

### Task 3: Environment Variable Override (AC: 3)
1. Implement environment variable support:
   - `TRAVELAI_WEATHER_API_KEY`
   - `TRAVELAI_CACHE_TTL_HOURS`
   - `TRAVELAI_LOG_LEVEL`
2. Environment variables take precedence over config file
3. Add prefix-based environment variable parsing

### Task 4: Configuration Validation (AC: 4)
1. Implement `validate_api_keys()` method
2. Validate API key format (non-empty, reasonable length)
3. Validate numeric ranges (TTL hours, timeouts, etc.)
4. Validate file paths and permissions
5. Return clear error messages for validation failures

### Task 5: Sample Configuration (AC: 5)
1. Create `config/default.toml` with example values
2. Add comments explaining each setting
3. Include instructions in README.md for config setup
4. Add command to generate default config file

### Task 6: Integration with Main Application (AC: 2, 4)
1. Integrate config loading in main.rs
2. Handle configuration errors gracefully
3. Display helpful error messages for config issues
4. Add `--config` CLI option to specify custom config path

### Task 7: Testing (AC: 1-5)
1. Unit tests for config parsing and validation
2. Test environment variable override behavior
3. Test error handling for malformed config files
4. Test default value fallbacks

## Definition of Done
- [ ] All acceptance criteria met
- [ ] Configuration loads from `~/.config/travelai/config.toml`
- [ ] Environment variables override config file values
- [ ] Clear error messages for invalid configurations
- [ ] Sample configuration file provided and documented
- [ ] Unit tests pass for all configuration scenarios
- [ ] Integration with main CLI application works
- [ ] Documentation updated in README.md

## Technical Notes
- Use XDG Base Directory Specification for config location
- Implement hierarchical config loading (defaults → file → env vars)
- Secure handling of API keys (no logging, clear validation messages)
- Consider future expansion for additional API configurations
- Follow Rust conventions for config struct naming and organization

## Dependencies
- Story 1.1 (Project Setup and CLI Framework) - requires basic CLI structure and error handling

## Estimated Effort
3-4 hours of focused development