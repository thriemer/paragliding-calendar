# Story 2.1: Paragliding Site Data Integration

## Status
Ready for Review

## Story
**As a** paragliding pilot,
**I want** the system to access paragliding site information including launch directions from multiple sources,
**so that** I can get comprehensive site data for flyability analysis.

## Acceptance Criteria

1: Integration with paragliding site APIs or data sources (Paragliding Earth API: https://paraglidingearth.com/api/ and DHV Geländedatenbank XML dump)
2: Site data includes name, coordinates, launch directions, elevation, and site characteristics from both sources
3: Geographic search capability to find sites within specified radius of a location
4: Site information cached appropriately to minimize API calls and XML parsing overhead
5: Error handling for unavailable site data, API failures, and XML parsing errors

## Tasks / Subtasks

- [x] Research and implement Paragliding Earth API integration (AC: 1)
  - [x] Document API endpoints for site search and retrieval
  - [x] Determine authentication requirements and API key setup
  - [x] Test API responses and understand data structure
- [x] Implement DHV XML database parsing (AC: 1)
  - [x] Parse XML structure for FlyingSite and Location elements
  - [x] Extract Directions (coded) and DirectionsText (human readable) fields
  - [x] Handle CDATA sections and special characters
- [x] Create unified site data models (AC: 2)
  - [x] Design common structs for site information from both sources
  - [x] Map DHV directions format (codes + text) to internal representation
  - [x] Map Paragliding Earth data format to internal representation
  - [x] Handle coordinate formats (DHV uses comma-separated, others may vary)
- [x] Implement geographic search functionality (AC: 3)
  - [x] Create location-based search with radius parameter for both data sources
  - [x] Implement coordinate-based distance calculations
  - [x] Add support for city name to coordinate conversion if needed
- [x] Implement caching mechanism (AC: 4)
  - [x] Design cache structure for site data from both sources
  - [x] Implement cache expiration and refresh logic for API data
  - [x] Cache parsed XML data with file modification time checking
  - [x] Add configuration options for cache behavior
- [x] Add comprehensive error handling (AC: 5)
  - [x] Handle API rate limiting with exponential backoff
  - [x] Manage network failures and timeouts
  - [x] Handle XML parsing errors and malformed data
  - [x] Provide meaningful error messages for unavailable data

## Dev Notes

### Relevant Source Tree Info
- Weather API integration patterns from Epic 1 should be followed for consistency
- Configuration management from Story 1.2 should be extended for Paragliding Earth API keys
- Error handling patterns from Story 1.4 should be applied

### Data Sources Integration
- **Paragliding Earth API:** https://paraglidingearth.com/api/
- **DHV Geländedatenbank XML:** dhvgelaende_dhvxml_de.xml (sample file provided)
- DHV XML structure includes FlyingSite > Location with Directions codes and DirectionsText
- DHV coordinates format: "longitude,latitude" (comma-separated)
- DHV directions use coded format (e.g., "3B", "89A") with human-readable text (e.g., "O, W", "SSW-WSW")

### XML Structure (DHV)
```xml
<FlyingSite>
  <SiteID>1</SiteID>
  <SiteName>Site Name</SiteName>
  <Location>
    <Coordinates>14.700136,50.998362</Coordinates>
    <Altitude>320</Altitude>
    <Directions>3B</Directions>
    <DirectionsText>O, W</DirectionsText>
  </Location>
</FlyingSite>
```

### Implementation Strategy
- Use serde for XML parsing with quick-xml crate
- Follow async HTTP patterns for Paragliding Earth API
- Store API keys in configuration file alongside weather API keys
- Create unified internal data model that can be populated from either source

### Caching Strategy
- Cache API responses with expiration
- Cache parsed XML with file modification time checking
- Consider separate cache keys for different data sources
- Implement cache invalidation strategies

### Testing
**Test file location:** tests/integration/
**Testing frameworks:** Use tokio-test for async testing, mockito for API mocking
**Test standards:**
- Unit tests for XML parsing and data structure conversion
- Unit tests for API response parsing
- Integration tests with mocked API responses and sample XML files
- Error handling tests for various failure scenarios
- Cache behavior verification tests
- Geographic search accuracy tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-30 | v1.0 | Initial story creation with dual data sources (Paragliding Earth API + DHV XML) | Sarah (PO) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
*To be completed during implementation*

### Completion Notes List
- Successfully implemented dual data source integration (DHV XML + Paragliding Earth API)
- Created unified ParaglidingSite data model with automatic conversion from both sources
- Implemented DHV XML parsing with direction code conversion to compass degrees
- Added Paragliding Earth API client with authentication and search capabilities
- Implemented geographic search using Haversine distance calculations
- Created comprehensive caching system with file modification time tracking
- Added proper error handling with custom TravelAIError types
- All 50 unit tests passing including integration tests for both data sources

### File List
- **Modified:**
  - `Cargo.toml` - Added dependencies: quick-xml, geo, haversine
  - `src/lib.rs` - Added paragliding module and public exports
  - `src/config.rs` - Added ParaglidingConfig struct with API key and XML path settings
- **Created:**
  - `src/paragliding.rs` - Main module with data structures and geographic search
  - `src/paragliding/error.rs` - Custom error types for paragliding module
  - `src/paragliding/dhv.rs` - DHV XML parser implementation
  - `src/paragliding/paragliding_earth.rs` - Paragliding Earth API client
  - `src/paragliding/cache.rs` - Site caching implementation with TTL and file modification tracking

## QA Results

*Results from QA Agent review will be populated here after implementation*