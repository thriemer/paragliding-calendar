# Story 2.1: Paragliding Site Data Integration

## Status
Draft

## Story
**As a** paragliding pilot,
**I want** the system to access paragliding site information including launch directions from multiple sources,
**so that** I can get comprehensive site data for flyability analysis.

## Acceptance Criteria

1: Integration with paragliding site APIs or data sources (Paragliding Earth API: https://paraglidingearth.com/api/ and DHV Geländedatenbank XML dump)
2: Site data includes name, coordinates, launch directions, elevation, and site characteristics from both sources
3: Geographic search capability to find sites within specified radius of a location
4: Site information cached appropriately to minimize API calls and XML parsing overhead
5: Error handling for unavailable site data, API failures, and XML parsing errors

## Tasks / Subtasks

- [ ] Research and implement Paragliding Earth API integration (AC: 1)
  - [ ] Document API endpoints for site search and retrieval
  - [ ] Determine authentication requirements and API key setup
  - [ ] Test API responses and understand data structure
- [ ] Implement DHV XML database parsing (AC: 1)
  - [ ] Parse XML structure for FlyingSite and Location elements
  - [ ] Extract Directions (coded) and DirectionsText (human readable) fields
  - [ ] Handle CDATA sections and special characters
- [ ] Create unified site data models (AC: 2)
  - [ ] Design common structs for site information from both sources
  - [ ] Map DHV directions format (codes + text) to internal representation
  - [ ] Map Paragliding Earth data format to internal representation
  - [ ] Handle coordinate formats (DHV uses comma-separated, others may vary)
- [ ] Implement geographic search functionality (AC: 3)
  - [ ] Create location-based search with radius parameter for both data sources
  - [ ] Implement coordinate-based distance calculations
  - [ ] Add support for city name to coordinate conversion if needed
- [ ] Implement caching mechanism (AC: 4)
  - [ ] Design cache structure for site data from both sources
  - [ ] Implement cache expiration and refresh logic for API data
  - [ ] Cache parsed XML data with file modification time checking
  - [ ] Add configuration options for cache behavior
- [ ] Add comprehensive error handling (AC: 5)
  - [ ] Handle API rate limiting with exponential backoff
  - [ ] Manage network failures and timeouts
  - [ ] Handle XML parsing errors and malformed data
  - [ ] Provide meaningful error messages for unavailable data

## Dev Notes

### Relevant Source Tree Info
- Weather API integration patterns from Epic 1 should be followed for consistency
- Configuration management from Story 1.2 should be extended for Paragliding Earth API keys
- Error handling patterns from Story 1.4 should be applied

### Data Sources Integration
- **Paragliding Earth API:** https://paraglidingearth.com/api/
- **DHV Geländedatenbank XML:** dhvgelaende_dhvxml_de.xml (sample file provided)
- DHV XML structure includes FlyingSite > Location with Directions codes and DirectionsText
- DHV coordinates format: "longitude,latitude" (comma-separated)
- DHV directions use coded format (e.g., "3B", "89A") with human-readable text (e.g., "O, W", "SSW-WSW")

### XML Structure (DHV)
```xml
<FlyingSite>
  <SiteID>1</SiteID>
  <SiteName>Site Name</SiteName>
  <Location>
    <Coordinates>14.700136,50.998362</Coordinates>
    <Altitude>320</Altitude>
    <Directions>3B</Directions>
    <DirectionsText>O, W</DirectionsText>
  </Location>
</FlyingSite>
```

### Implementation Strategy
- Use serde for XML parsing with quick-xml crate
- Follow async HTTP patterns for Paragliding Earth API
- Store API keys in configuration file alongside weather API keys
- Create unified internal data model that can be populated from either source

### Caching Strategy
- Cache API responses with expiration
- Cache parsed XML with file modification time checking
- Consider separate cache keys for different data sources
- Implement cache invalidation strategies

### Testing
**Test file location:** tests/integration/
**Testing frameworks:** Use tokio-test for async testing, mockito for API mocking
**Test standards:**
- Unit tests for XML parsing and data structure conversion
- Unit tests for API response parsing
- Integration tests with mocked API responses and sample XML files
- Error handling tests for various failure scenarios
- Cache behavior verification tests
- Geographic search accuracy tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-30 | v1.0 | Initial story creation with dual data sources (Paragliding Earth API + DHV XML) | Sarah (PO) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be completed during implementation*

### Debug Log References
*To be completed during implementation*

### Completion Notes List
*To be completed during implementation*

### File List
*To be completed during implementation*

## QA Results

*Results from QA Agent review will be populated here after implementation*