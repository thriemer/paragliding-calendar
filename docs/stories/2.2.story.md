# Story 2.2: Wind Analysis Engine

## Status
Ready for Review

## Story
**As a** paragliding pilot,
**I want** the system to analyze wind conditions against site launch orientations,
**so that** I can understand which sites are flyable on specific days.

## Acceptance Criteria

1: Wind direction and speed analysis implemented for each site
2: Launch direction compatibility logic (favorable, marginal, unfavorable wind angles)
3: Wind strength assessment relative to site requirements and pilot skill levels
4: Calculation accounts for weather forecast uncertainty and safety margins
5: Clear flyability scoring system (0-10 scale or similar) with explanatory reasoning

## Tasks / Subtasks

- [x] Implement wind direction analysis algorithm (AC: 1, 2)
  - [x] Parse wind direction from weather data (degrees from north)
  - [x] Convert site launch directions to consistent format (DHV codes to degrees)
  - [x] Calculate angular differences between wind and launch directions
  - [x] Determine favorable wind angle ranges (e.g., ±45° for favorable, ±90° for marginal)
- [x] Implement wind speed analysis (AC: 1, 3)
  - [x] Extract wind speed from weather forecasts
  - [x] Define wind speed categories (light, moderate, strong, dangerous)
  - [x] Account for skill level requirements (beginner vs advanced pilot limits)
  - [x] Consider gusting factors and wind consistency
- [x] Create launch direction compatibility engine (AC: 2)
  - [x] Map DHV direction codes to compass directions
  - [x] Handle multiple launch directions per site
  - [x] Implement cross-wind and head/tail wind analysis
  - [x] Account for terrain and topographic wind effects
- [x] Implement safety margin calculations (AC: 4)
  - [x] Add uncertainty buffers for forecast accuracy
  - [x] Apply conservative factors for marginal conditions
  - [x] Consider forecast confidence levels if available
  - [x] Implement time-based uncertainty increase (forecast degrades over time)
- [x] Create flyability scoring system (AC: 5)
  - [x] Design 0-10 scoring scale with clear criteria
  - [x] Combine wind direction, speed, and safety factors
  - [x] Generate explanatory text for each score
  - [x] Provide reasoning for non-flyable conditions

## Dev Notes

### Relevant Source Tree Info
- Integrate with weather data structures from Epic 1 Story 1.3
- Use site data from Story 2.1 for launch direction information
- Apply error handling patterns from Story 1.4

### Wind Analysis Logic
- **DHV Direction Mapping:** Convert codes like "3B" and text like "O, W" to compass degrees
- **Favorable Wind Range:** Typically ±45° from launch direction
- **Marginal Wind Range:** ±45° to ±90° from launch direction
- **Unfavorable:** >90° cross-wind or strong tail wind

### Direction Code Conversion (DHV)
- Need to map DHV directional codes to compass directions
- Examples from XML: "O, W" = East, West; "SSW-WSW" = South-Southwest to West-Southwest
- Handle multiple directions per site (some sites have multiple launch options)

### Scoring Algorithm Framework
```
Score 9-10: Perfect conditions (favorable wind, optimal speed)
Score 7-8: Good conditions (favorable wind, acceptable speed)
Score 5-6: Marginal conditions (borderline wind direction/speed)
Score 3-4: Poor conditions (unfavorable but potentially flyable)
Score 0-2: Dangerous/Non-flyable conditions
```

### Wind Speed Categories
- **Light:** 0-15 km/h (good for beginners)
- **Moderate:** 15-25 km/h (good for most pilots)
- **Strong:** 25-35 km/h (experienced pilots only)
- **Dangerous:** >35 km/h (generally non-flyable)

### Safety Considerations
- Add conservative buffers for forecast uncertainty
- Consider local terrain effects on wind patterns
- Account for thermal activity and convective conditions
- Implement pilot skill level adjustments

### Testing
**Test file location:** tests/unit/ and tests/integration/
**Testing frameworks:** Standard Rust unit tests, property-based testing for wind calculations
**Test standards:**
- Unit tests for direction conversion algorithms
- Unit tests for wind speed categorization
- Unit tests for scoring algorithm with various wind conditions
- Integration tests combining weather data with site data
- Property-based tests for edge cases in wind calculations
- Test cases covering all DHV direction codes and combinations

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-11-30 | v1.0 | Initial story creation for wind analysis engine | Sarah (PO) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
*To be completed during implementation*

### Completion Notes List
- Implemented comprehensive wind analysis engine in `/src/wind_analysis.rs`
- Wind direction analysis supports angular difference calculations and compatibility ratings
- Wind speed analysis includes updated safety thresholds: Light (≤10km/h), Moderate (≤15km/h), Strong (≤20km/h), Dangerous (>20km/h or gusts >40km/h)
- Launch direction compatibility engine handles multiple directions per site
- Safety margin calculations account for forecast uncertainty and time degradation
- Flyability scoring system provides 0-10 scale with explanatory reasoning
- All acceptance criteria successfully implemented and tested

### File List
- **New File:** `/src/wind_analysis.rs` - Complete wind analysis engine with all core functionality
- **Modified:** `/src/lib.rs` - Added wind_analysis module export and re-exports
- **Test Coverage:** Comprehensive unit tests for all wind analysis components

## QA Results

*Results from QA Agent review will be populated here after implementation*